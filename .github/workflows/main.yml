name: ci

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  build:
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 4
      matrix:
        java-version: [ 8 ]
        python-version: [ 3.6 ]

    env:
      DOCKER_IMAGE: "aemdesign/centos-java-buildpack:jdk11"
      SONAR_ORGANISATION: "aemdesign-github"
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_URL: "https://sonarcloud.io"
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      SONATYPE_USERNAME: "aemdesign"
      GITHUB_USER: aemdesign
      TRAVIS_TOKEN: ${{ secrets.TRAVIS_TOKEN }}
      GITHUB_EMAIL: ${{ secrets.GITHUB_EMAIL }}
      GITHUB_USERNAME: ${{ secrets.GITHUB_USERNAME }}
      GITHUB_TOKEN_ADMIN: ${{ secrets.GITHUB_TOKEN_ADMIN }}
      AEM_NAME: ${{ secrets.AEM_NAME }}
      AEM_KEY: ${{ secrets.AEM_KEY }}
      GPG_SECRET_KEYS: ${{ secrets.GPG_SECRET_KEYS }}
      GPG_OWNERTRUST: ${{ secrets.GPG_OWNERTRUST }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      GPG_EXECUTABLE: gpg
      GPG_PRESET_EXECUTABLE: /usr/lib/gnupg/gpg-preset-passphrase
      GPG_PUBID: "50A036956AAC64C13EF47B10D1E96A30ECFC7DFF"
      GPG_PUBID_KEYGRIP: "020E615868703482DC2CD110B98D2702B6ABF89C"

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
          lfs: true
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: set up jdk ${{ matrix.java-version }}
        uses: actions/setup-java@v1
        with:
          java-version: ${{ matrix.java-version }}

      - uses: actions/setup-node@v1
        with:
          node-version: '10.x'
          registry-url: https://npm.pkg.github.com/
          scope: "@aem-design"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN_ADMIN }}
      - name: set up python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: get release notes
        id: config
        run: |
          source <(curl -sL https://github.com/aem-design/aemdesign-docker/releases/latest/download/github_get_version.sh)

      - name: release notes
        run: |
          echo "${{ steps.config.outputs.GIT_RELEASE_NOTES }}"
          echo CURRENT_VERSION="${{ steps.config.outputs.CURRENT_VERSION }}"

      - name: set eval variables
        run: |
          echo "DOCKER_COMMAND=docker run --user $(id -u):$(id -g) -v ${GITHUB_WORKSPACE}:/build ${DOCKER_IMAGE}" >> $GITHUB_ENV
          $DOCKER_COMMAND java -version
          $DOCKER_COMMAND node -v
          git config --global user.email "${GITHUB_EMAIL}"
          git config --global user.name "${GITHUB_USERNAME}"

      - name: setup gpg
        run: |
          source <(curl -sL https://github.com/aem-design/aemdesign-docker/releases/latest/download/setup-gpg.sh)

      - name: cache sonarcloud packages
        uses: actions/cache@v1
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: cache maven packages
        uses: actions/cache@v1
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Prepare to Package
        run: $DOCKER_COMMAND mvn clean -DskipTests=true -Dgpg.skip -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -B -P all-modules -Dmaven.repo.local=./build/.m2/repository

      - name: Package project and install into local .m2 repository
        run: $DOCKER_COMMAND mvn package install -DskipTests=true -Dgpg.skip -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -B -P all-modules -Dmaven.repo.local=./build/.m2/repository

      - name: Start the stack
        run: docker-compose up -d

      - name: Wait for aem using ansible
        run: |
          docker-compose up automationtestprep

      - name: Start automation tests using docker-compose
        run: |
          docker-compose up automationtest

      - name: deploy docs
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          destination_dir: ${{ env.GIT_BRANCH }}
          publish_dir: ./aemdesign-testing/remote-seleniumhub-chrome/generated-docs/html/

      - name: Check for success
        run: |
          docker-compose up testingcheck

      - name: Stop the stack
        run: docker-compose down

#      - name: docker - sonar qube on master
#        if: github.ref == 'refs/heads/master'
#        run: mvn sonar:sonar -P all-modules -q "-Dsonar.branch.name=${GITHUB_REF}" "-Dsonar.host.url=${SONAR_URL}" "-Dsonar.login=${SONAR_TOKEN}" "-Dsonar.organization=${SONAR_ORGANISATION}"
#      - name: docker - sonar qube on master
#        if: github.ref != 'refs/heads/master'
#        run: mvn sonar:sonar -P all-modules -q "-Dsonar.branch.name=${GITHUB_REF}" "-Dsonar.branch.target=master" "-Dsonar.host.url=${SONAR_URL}" "-Dsonar.login=${SONAR_TOKEN}" "-Dsonar.organization=${SONAR_ORGANISATION}"

#      - name: install dependencies
#        run: |
#          sudo apt-get update --fix-missing
#          sudo apt-get install ansible libcurl4-openssl-dev libssl-dev socat default-jdk
#          python -m pip install --upgrade pip
#          pip install -r requirements.txt

#      - name: automation test
#        id: automation_test
#        run: ./automation-testing
#
#      - name: automation test release reports
#        if: github.ref == 'refs/heads/master'
#        run: ./automation-testing-release
#        env:
#          TEST_REPORT_OUTPUT: ${{ steps.automation_test.outputs.TEST_REPORT_OUTPUT }}
#          TEST_REPORT_COMPARE_SOURCES: ${{ steps.automation_test.outputs.TEST_REPORT_COMPARE_SOURCES }}
#          TEST_REPORT_GHPAGES_PATH: ${{ steps.automation_test.outputs.TEST_REPORT_GHPAGES_PATH }}

      - name: deploy to maven cental
        if: github.ref == 'refs/heads/master'
        run: $DOCKER_COMMAND echo $GPG_SECRET_KEYS | base64 --decode | $GPG_EXECUTABLE --import && echo $GPG_OWNERTRUST | base64 --decode | $GPG_EXECUTABLE --import-ownertrust && mvn deploy --settings default.xml -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests=true -B -P release

      - name: create release ${{ env.GITHUB_TAG }}
        if: github.ref == 'refs/heads/master'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.config.outputs.CURRENT_VERSION }}
          release_name: ${{ steps.config.outputs.CURRENT_VERSION }}
          body: ${{ steps.config.outputs.GIT_RELEASE_NOTES }}
          draft: false
          prerelease: false

      - name: upload release asset - aemdesign-aem-support-${{ env.GITHUB_TAG }}.zip
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ format('./aemdesign-aem-{0}/target/aemdesign-aem-{0}-{1}.zip', 'support-deploy', env.GITHUB_TAG) }}
          asset_name: ${{ format('aemdesign-aem-{0}-{1}.zip', 'support-deploy', env.GITHUB_TAG) }}
          asset_content_type: application/zip

      - name: upload release asset - aemdesign-aem-compose-${{ env.GITHUB_TAG }}.zip
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ format('./aemdesign-aem-{0}/target/aemdesign-aem-{0}-{1}.zip', 'compose', env.GITHUB_TAG) }}
          asset_name: ${{ format('aemdesign-aem-{0}-{1}.zip', 'compose', env.GITHUB_TAG) }}
          asset_content_type: application/zip

      - name: upload release asset - aemdesign-aem-showcase-${{ env.GITHUB_TAG }}.zip
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ format('./aemdesign-aem-{0}/target/aemdesign-aem-{0}-{1}.zip', 'showcase', env.GITHUB_TAG) }}
          asset_name: ${{ format('aemdesign-aem-{0}-{1}.zip', 'showcase', env.GITHUB_TAG) }}
          asset_content_type: application/zip

      - name: upload release asset - aemdesign-aem-training-${{ env.GITHUB_TAG }}.zip
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ format('./aemdesign-aem-{0}/target/aemdesign-aem-{0}-{1}.zip', 'training', env.GITHUB_TAG) }}
          asset_name: ${{ format('aemdesign-aem-{0}-{1}.zip', 'training', env.GITHUB_TAG) }}
          asset_content_type: application/zip

      - name: upload release asset - aemdesign-aem-content-${{ env.GITHUB_TAG }}.zip
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ format('./aemdesign-aem-{0}/target/aemdesign-aem-{0}-{1}.zip', 'content', env.GITHUB_TAG) }}
          asset_name: ${{ format('aemdesign-aem-{0}-{1}.zip', 'content', env.GITHUB_TAG) }}
          asset_content_type: application/zip

      - name: upload release asset - aemdesign-aem-config-${{ env.GITHUB_TAG }}.zip
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ format('./aemdesign-aem-{0}/target/aemdesign-aem-{0}-{1}.zip', 'config', env.GITHUB_TAG) }}
          asset_name: ${{ format('aemdesign-aem-{0}-{1}.zip', 'config', env.GITHUB_TAG) }}
          asset_content_type: application/zip

      - name: automation test if failure
        run: |
          df
          docker ps -a
          docker logs -t service_aem_container_name
        if: failure()

